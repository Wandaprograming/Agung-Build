name: React Native APK Builder

run-name: Build RN ${{ inputs.appName }}

on:
  workflow_dispatch:
    inputs:
      id:
        required: true
        type: string
      appName:
        required: true
        type: string
      packageName:
        required: true
        type: string
      versionCode:
        required: true
        type: string
      versionName:
        required: true
        type: string
      iconUrl:
        required: true
        type: string
      webhookUrl:
        required: true
        type: string
      uploadUrl:
        required: true
        type: string
      logUrl:
        required: true
        type: string
      mode:
        required: true
        type: string
      url:
        required: false
        type: string
      projectZip:
        required: false
        type: string
      buildFormat:
        required: false
        type: string
        default: 'apk'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Initialize Builder
        run: |
          echo "BUILD_EXT=$(echo '${{ inputs.buildFormat }}' | tr '[:lower:]' '[:upper:]')" >> $GITHUB_ENV

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Cache NPM Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-cache-${{ runner.os }}
          restore-keys: |
            npm-cache-${{ runner.os }}

      - name: Cache Expo Base Project
        id: cache-expo
        uses: actions/cache@v4
        with:
          path: base-rn-project
          key: expo-base-template-v1

      - name: Create Expo Project Base (If Not Cached)
        if: steps.cache-expo.outputs.cache-hit != 'true'
        run: |
          npx create-expo-app@latest base-rn-project --template blank

      - name: Extract User Source Code
        run: |
          curl -X POST -H "Content-Type: application/json" -d "{\"id\": \"${{ inputs.id }}\", \"log\": \"[RN Builder] Mengintegrasikan Source Code...\"}" "${{ inputs.logUrl }}"
          echo "${{ inputs.projectZip }}" | base64 -d > source.zip
          unzip -q -o source.zip -d extracted_source/

      - name: Prepare Working Project
        run: |
          curl -X POST -H "Content-Type: application/json" -d "{\"id\": \"${{ inputs.id }}\", \"log\": \"[RN Builder] Menyiapkan environment React Native...\"}" "${{ inputs.logUrl }}"
          
          cp -R base-rn-project rn-project
          
          cat <<EOF > rn-project/app.json
          {
            "expo": {
              "name": "${{ inputs.appName }}",
              "slug": "rn-app",
              "version": "${{ inputs.versionName }}",
              "orientation": "portrait",
              "icon": "./assets/icon.png",
              "android": {
                "package": "${{ inputs.packageName }}",
                "versionCode": ${{ inputs.versionCode }},
                "adaptiveIcon": {
                  "foregroundImage": "./assets/icon.png",
                  "backgroundColor": "#ffffff"
                }
              }
            }
          }
          EOF
          
          curl -sL "${{ inputs.iconUrl }}" -o rn-project/assets/icon.png
          
          cp -R extracted_source/www/* rn-project/
          rm -f rn-project/index.html
          
          cd rn-project
          npm install --no-audit --no-fund --legacy-peer-deps

      - name: Prebuild Native Code
        run: |
          curl -X POST -H "Content-Type: application/json" -d "{\"id\": \"${{ inputs.id }}\", \"log\": \"[RN Builder] Mengompilasi konfigurasi Native Android...\"}" "${{ inputs.logUrl }}"
          cd rn-project
          npx expo prebuild --platform android --clean

      - name: Compile APK/AAB
        run: |
          curl -X POST -H "Content-Type: application/json" -d "{\"id\": \"${{ inputs.id }}\", \"log\": \"[RN Builder] Memulai kompilasi Gradle (Turbo Mode)...\"}" "${{ inputs.logUrl }}"
          cd rn-project/android
          chmod +x gradlew
          if [ "${{ inputs.buildFormat }}" == "aab" ]; then
              ./gradlew bundleRelease --no-daemon --parallel --build-cache --configure-on-demand --max-workers=2
          else
              ./gradlew assembleRelease --no-daemon --parallel --build-cache --configure-on-demand --max-workers=2
          fi

      - name: Upload Artifact
        if: success()
        run: |
          curl -X POST -H "Content-Type: application/json" -d "{\"id\": \"${{ inputs.id }}\", \"log\": \"[RN Builder] Mengirim file aplikasi ke server utama...\"}" "${{ inputs.logUrl }}"
          if [ "${{ inputs.buildFormat }}" == "aab" ]; then
              FILE_PATH="rn-project/android/app/build/outputs/bundle/release/app-release.aab"
              EXT="aab"
          else
              FILE_PATH="rn-project/android/app/build/outputs/apk/release/app-release.apk"
              EXT="apk"
          fi
          curl -X PUT --data-binary @"$FILE_PATH" "${{ inputs.uploadUrl }}&id=${{ inputs.id }}&ext=$EXT"

      - name: Notify System
        if: always()
        run: |
          STATUS="failed"
          if [ "${{ job.status }}" == "success" ]; then
              STATUS="success"
          fi
          curl -X POST -H "Content-Type: application/json" -d "{\"id\": \"${{ inputs.id }}\", \"status\": \"$STATUS\"}" "${{ inputs.webhookUrl }}"
