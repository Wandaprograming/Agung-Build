name: Pro Native Compiler

run-name: Compile ${{ inputs.appName }}

on:
  workflow_dispatch:
    inputs:
      id: { required: true, type: string }
      appName: { required: true, type: string }
      packageName: { required: true, type: string }
      versionCode: { required: true, type: string }
      versionName: { required: true, type: string }
      iconUrl: { required: true, type: string }
      webhookUrl: { required: true, type: string }
      uploadUrl: { required: true, type: string }
      logUrl: { required: true, type: string }
      mode: { required: true, type: string }
      url: { required: false, type: string }
      projectZip: { required: false, type: string }
      buildFormat: { required: false, type: string, default: 'apk' }
      minSdk: { required: false, type: string, default: '24' }
      targetSdk: { required: false, type: string, default: '34' }

permissions: { contents: write }

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Init
        run: echo "BUILD_EXT=$(echo '${{ inputs.buildFormat }}' | tr '[:lower:]' '[:upper:]')" >> $GITHUB_ENV

      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - uses: actions/setup-java@v4
        with: { distribution: 'zulu', java-version: '17' }

      - name: Core Caching
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            ~/.gradle/caches
            ~/.gradle/wrapper
            base-rn-project
          key: engine-cache-v4-${{ runner.os }}-${{ github.run_id }}
          restore-keys: |
            engine-cache-v4-${{ runner.os }}-

      - name: Prepare Base Engine
        run: |
          if [ ! -d "base-rn-project" ]; then
            npx create-expo-app@latest base-rn-project --template blank
          fi

      - name: Inject Source & Configure
        run: |
          set -o pipefail
          curl -s -X POST -H "Content-Type: application/json" -d "{\"id\": \"${{ inputs.id }}\", \"log\": \"[SYSTEM] Menyiapkan Cloud Workspace...\"}" "${{ inputs.logUrl }}" || true
          
          echo "${{ inputs.projectZip }}" | base64 -d > source.zip
          unzip -q -o source.zip -d extracted_source/
          cp -R base-rn-project rn-project
          
          SAFE_PKG=$(echo "${{ inputs.packageName }}" | tr '[:upper:]' '[:lower:]' | tr '-' '_' | sed 's/[^a-z0-9._]//g' | sed -E 's/(^|\.)([0-9])/\1n\2/g')
          SAFE_PKG=${SAFE_PKG//native/ntv}; SAFE_PKG=${SAFE_PKG//default/dflt}
          if [[ "$SAFE_PKG" != *.* ]]; then SAFE_PKG="com.$SAFE_PKG.app"; fi
          if [ -z "$SAFE_PKG" ] || [ "$SAFE_PKG" == "com..app" ]; then SAFE_PKG="com.app.studio"; fi
          SAFE_VC=$(echo "${{ inputs.versionCode }}" | sed 's/[^0-9]//g'); SAFE_VC=${SAFE_VC:-1}
          
          rm -f rn-project/App.js rn-project/index.html
          cp -a extracted_source/. rn-project/
          
          if [ -f "rn-project/app.json" ]; then
            jq --arg pkg "$SAFE_PKG" --arg vc "$SAFE_VC" --arg vn "${{ inputs.versionName }}" --arg name "${{ inputs.appName }}" 'del(.expo.android.adaptiveIcon) | .expo.name = $name | .expo.version = $vn | .expo.android.package = $pkg | .expo.android.versionCode = ($vc|tonumber) | .expo.icon = "./assets/icon.png" | .expo.splash.image = "./assets/icon.png"' rn-project/app.json > tmp.json && mv tmp.json rn-project/app.json
          else
            cat <<EOF > rn-project/app.json
            {
              "expo": {
                "name": "${{ inputs.appName }}", "slug": "rn-app", "version": "${{ inputs.versionName }}", "orientation": "portrait",
                "icon": "./assets/icon.png",
                "splash": { "image": "./assets/icon.png", "resizeMode": "contain", "backgroundColor": "#ffffff" },
                "android": { 
                  "package": "$SAFE_PKG", 
                  "versionCode": $SAFE_VC
                }
              }
            }
          EOF
          fi
          
          mkdir -p rn-project/assets
          curl -sL "${{ inputs.iconUrl }}" -o rn-project/assets/icon.png || true
          if [ ! -f "rn-project/assets/icon.png" ] || ! file rn-project/assets/icon.png | grep -qE 'image|bitmap'; then
            echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" | base64 -d > rn-project/assets/icon.png
          fi
          
          cd rn-project
          
          rm -f package-lock.json yarn.lock
          
          if ! npm install --no-audit --no-fund --legacy-peer-deps 2>&1 | tee npm.log; then
              ERR=$(tail -n 15 npm.log | tr -d '"' | tr -d "'" | tr -d '\\' | tr '\n' ' ' | cut -c 1-400)
              jq -n --arg id "${{ inputs.id }}" --arg log "[ERROR] Setup Paket Gagal: $ERR" '{id: $id, log: $log}' > payload.json
              curl -s -X POST -H "Content-Type: application/json" -d @payload.json "${{ inputs.logUrl }}" || true
              exit 1
          fi

      - name: Generate Native Bridge
        run: |
          set -o pipefail
          curl -s -X POST -H "Content-Type: application/json" -d "{\"id\": \"${{ inputs.id }}\", \"log\": \"[SYSTEM] Mengompilasi Bridge Native Android...\"}" "${{ inputs.logUrl }}" || true
          cd rn-project
          if ! npx expo prebuild --platform android --clean 2>&1 | tee prebuild.log; then
              ERR=$(tail -n 20 prebuild.log | tr -d '"' | tr -d "'" | tr -d '\\' | tr '\n' ' ' | cut -c 1-400)
              jq -n --arg id "${{ inputs.id }}" --arg log "[ERROR] Prebuild Native Gagal: $ERR" '{id: $id, log: $log}' > payload.json
              curl -s -X POST -H "Content-Type: application/json" -d @payload.json "${{ inputs.logUrl }}" || true
              exit 1
          fi

          cd android
          sed -i 's/def enableSeparateBuildPerCPUArchitecture = false/def enableSeparateBuildPerCPUArchitecture = true/g' app/build.gradle
          echo "reactNativeArchitectures=arm64-v8a" >> gradle.properties
          echo "android.enableProguardInReleaseBuilds=true" >> gradle.properties
          echo "org.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=512m" >> gradle.properties
          
          sed -i -E "s/minSdkVersion = [0-9]+/minSdkVersion = ${{ inputs.minSdk }}/g" build.gradle || true
          sed -i -E "s/targetSdkVersion = [0-9]+/targetSdkVersion = ${{ inputs.targetSdk }}/g" build.gradle || true
          sed -i -E "s/compileSdkVersion = [0-9]+/compileSdkVersion = ${{ inputs.targetSdk }}/g" build.gradle || true

      - name: Turbo Compile
        run: |
          set -o pipefail
          curl -s -X POST -H "Content-Type: application/json" -d "{\"id\": \"${{ inputs.id }}\", \"log\": \"[SYSTEM] Mengeksekusi Gradle... (Tunggu Notifikasi saat Selesai)\"}" "${{ inputs.logUrl }}" || true
          cd rn-project/android
          chmod +x gradlew
          
          CMD="./gradlew assembleRelease --no-daemon --parallel --build-cache --configure-on-demand --max-workers=4"
          if [ "${{ inputs.buildFormat }}" == "aab" ]; then CMD="./gradlew bundleRelease --no-daemon --parallel --build-cache --configure-on-demand --max-workers=4"; fi
          
          if ! $CMD 2>&1 | tee gradle.log; then
              ERR=$(tail -n 30 gradle.log | tr -d '"' | tr -d "'" | tr -d '\\' | tr '\n' ' ' | cut -c 1-400)
              jq -n --arg id "${{ inputs.id }}" --arg log "[ERROR] Kompilasi Gagal:\n$ERR" '{id: $id, log: $log}' > payload.json
              curl -s -X POST -H "Content-Type: application/json" -d @payload.json "${{ inputs.logUrl }}" || true
              exit 1
          fi

      - name: Upload Artifact
        if: success()
        run: |
          curl -s -X POST -H "Content-Type: application/json" -d "{\"id\": \"${{ inputs.id }}\", \"log\": \"[SYSTEM] Mengirim File ke Server...\"}" "${{ inputs.logUrl }}" || true
          if [ "${{ inputs.buildFormat }}" == "aab" ]; then
              FILE="rn-project/android/app/build/outputs/bundle/release/app-release.aab"; EXT="aab"
          else
              FILE=$(find rn-project/android/app/build/outputs/apk/release -name "*arm64-v8a-release.apk" | head -n 1)
              if [ -z "$FILE" ]; then FILE=$(find rn-project/android/app/build/outputs/apk/release -name "*.apk" | head -n 1); fi
              EXT="apk"
          fi
          curl -s -X PUT --data-binary @"$FILE" "${{ inputs.uploadUrl }}&id=${{ inputs.id }}&ext=$EXT" || true

      - name: Finalize
        if: always()
        run: |
          STATUS="failed"; if [ "${{ job.status }}" == "success" ]; then STATUS="success"; fi
          curl -s -X POST -H "Content-Type: application/json" -d "{\"id\": \"${{ inputs.id }}\", \"status\": \"$STATUS\"}" "${{ inputs.webhookUrl }}" || true
