name: React Native APK Builder

run-name: Build RN ${{ inputs.appName }}

on:
  workflow_dispatch:
    inputs:
      id:
        required: true
        type: string
      appName:
        required: true
        type: string
      packageName:
        required: true
        type: string
      versionCode:
        required: true
        type: string
      versionName:
        required: true
        type: string
      iconUrl:
        required: true
        type: string
      webhookUrl:
        required: true
        type: string
      uploadUrl:
        required: true
        type: string
      logUrl:
        required: true
        type: string
      mode:
        required: true
        type: string
      url:
        required: false
        type: string
      projectZip:
        required: false
        type: string
      buildFormat:
        required: false
        type: string
        default: 'apk'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Initialize Builder
        run: |
          echo "BUILD_EXT=$(echo '${{ inputs.buildFormat }}' | tr '[:lower:]' '[:upper:]')" >> $GITHUB_ENV

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Cache NPM Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-cache-${{ runner.os }}
          restore-keys: |
            npm-cache-${{ runner.os }}-

      - name: Cache Gradle & Android NDK
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            /usr/local/lib/android/sdk/ndk
          key: gradle-ndk-${{ runner.os }}-${{ github.run_id }}
          restore-keys: |
            gradle-ndk-${{ runner.os }}-

      - name: Cache Expo Base Project
        id: cache-expo
        uses: actions/cache@v4
        with:
          path: base-rn-project
          key: expo-base-template-v1

      - name: Create Expo Project Base (If Not Cached)
        if: steps.cache-expo.outputs.cache-hit != 'true'
        run: |
          npx create-expo-app@latest base-rn-project --template blank

      - name: Extract User Source Code
        run: |
          curl -X POST -H "Content-Type: application/json" -d "{\"id\": \"${{ inputs.id }}\", \"log\": \"[RN Builder] Mengintegrasikan Source Code...\"}" "${{ inputs.logUrl }}"
          echo "${{ inputs.projectZip }}" | base64 -d > source.zip
          unzip -q -o source.zip -d extracted_source/

      - name: Prepare Working Project
        run: |
          set -o pipefail
          curl -X POST -H "Content-Type: application/json" -d "{\"id\": \"${{ inputs.id }}\", \"log\": \"[RN Builder] Validasi & Menyiapkan environment...\"}" "${{ inputs.logUrl }}"
          
          cp -R base-rn-project rn-project
          
          SAFE_PKG=$(echo "${{ inputs.packageName }}" | tr '[:upper:]' '[:lower:]' | tr '-' '_')
          SAFE_PKG=$(echo "$SAFE_PKG" | sed 's/[^a-z0-9._]//g')
          SAFE_PKG=$(echo "$SAFE_PKG" | sed -E 's/(^|\.)([0-9])/\1n\2/g')
          SAFE_PKG=${SAFE_PKG//native/ntv}
          SAFE_PKG=${SAFE_PKG//default/dflt}
          if [[ "$SAFE_PKG" != *.* ]]; then SAFE_PKG="com.$SAFE_PKG.app"; fi
          if [ -z "$SAFE_PKG" ] || [ "$SAFE_PKG" == "com..app" ]; then SAFE_PKG="com.app.studio"; fi

          SAFE_VC=$(echo "${{ inputs.versionCode }}" | sed 's/[^0-9]//g')
          if [ -z "$SAFE_VC" ]; then SAFE_VC="1"; fi
          
          cat <<EOF > rn-project/app.json
          {
            "expo": {
              "name": "${{ inputs.appName }}",
              "slug": "rn-app",
              "version": "${{ inputs.versionName }}",
              "orientation": "portrait",
              "icon": "./assets/icon.png",
              "android": {
                "package": "$SAFE_PKG",
                "versionCode": $SAFE_VC,
                "adaptiveIcon": {
                  "foregroundImage": "./assets/icon.png",
                  "backgroundColor": "#ffffff"
                }
              }
            }
          }
          EOF
          
          curl -sL "${{ inputs.iconUrl }}" -o rn-project/assets/icon.png
          
          rm -f rn-project/App.js
          rm -f rn-project/index.html
          cp -a extracted_source/. rn-project/
          
          cd rn-project
          
          if ! npm install --no-audit --no-fund --legacy-peer-deps 2>&1 | tee npm_install.log; then
              ERR=$(tail -n 25 npm_install.log | sed 's|/home/runner/work/[^/]*/[^/]*|/workspace|g')
              jq -n --arg id "${{ inputs.id }}" --arg log "[ERROR] Instalasi Dependensi Gagal:
          $ERR" '{id: $id, log: $log}' | curl -X POST -H "Content-Type: application/json" -d @- "${{ inputs.logUrl }}"
              exit 1
          fi

      - name: Prebuild Native Code
        run: |
          set -o pipefail
          curl -X POST -H "Content-Type: application/json" -d "{\"id\": \"${{ inputs.id }}\", \"log\": \"[RN Builder] Mengompilasi konfigurasi Native Android...\"}" "${{ inputs.logUrl }}"
          cd rn-project
          
          if ! npx expo prebuild --platform android --clean 2>&1 | tee prebuild.log; then
              ERR=$(tail -n 25 prebuild.log | sed 's|/home/runner/work/[^/]*/[^/]*|/workspace|g')
              jq -n --arg id "${{ inputs.id }}" --arg log "[ERROR] Expo Prebuild Gagal:
          $ERR" '{id: $id, log: $log}' | curl -X POST -H "Content-Type: application/json" -d @- "${{ inputs.logUrl }}"
              exit 1
          fi

      - name: Compile APK/AAB
        run: |
          set -o pipefail
          curl -X POST -H "Content-Type: application/json" -d "{\"id\": \"${{ inputs.id }}\", \"log\": \"[RN Builder] Memulai kompilasi Gradle... (Proses ini wajar memakan waktu 3-8 Menit)\"}" "${{ inputs.logUrl }}"
          cd rn-project/android
          chmod +x gradlew
          
          CMD="./gradlew assembleRelease --no-daemon --parallel --build-cache --configure-on-demand --max-workers=2"
          if [ "${{ inputs.buildFormat }}" == "aab" ]; then
              CMD="./gradlew bundleRelease --no-daemon --parallel --build-cache --configure-on-demand --max-workers=2"
          fi
          
          # Menggunakan tee agar log tetap jalan di layar Terminal Github Actions
          if ! $CMD 2>&1 | tee gradle.log; then
              ERR=$(tail -n 40 gradle.log | sed 's|/home/runner/work/[^/]*/[^/]*|/workspace|g')
              jq -n --arg id "${{ inputs.id }}" --arg log "[ERROR] Kompilasi Code Gagal:
          $ERR" '{id: $id, log: $log}' | curl -X POST -H "Content-Type: application/json" -d @- "${{ inputs.logUrl }}"
              exit 1
          fi

      - name: Upload Artifact
        if: success()
        run: |
          curl -X POST -H "Content-Type: application/json" -d "{\"id\": \"${{ inputs.id }}\", \"log\": \"[RN Builder] Mengirim file aplikasi ke server utama...\"}" "${{ inputs.logUrl }}"
          if [ "${{ inputs.buildFormat }}" == "aab" ]; then
              FILE_PATH="rn-project/android/app/build/outputs/bundle/release/app-release.aab"
              EXT="aab"
          else
              FILE_PATH="rn-project/android/app/build/outputs/apk/release/app-release.apk"
              EXT="apk"
          fi
          curl -X PUT --data-binary @"$FILE_PATH" "${{ inputs.uploadUrl }}&id=${{ inputs.id }}&ext=$EXT"

      - name: Notify System
        if: always()
        run: |
          STATUS="failed"
          if [ "${{ job.status }}" == "success" ]; then
              STATUS="success"
          fi
          curl -X POST -H "Content-Type: application/json" -d "{\"id\": \"${{ inputs.id }}\", \"status\": \"$STATUS\"}" "${{ inputs.webhookUrl }}"
